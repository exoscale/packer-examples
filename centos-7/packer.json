{
    "variables": {
        "image_url": "http://miroir.univ-lorraine.fr/centos/7.6.1810/isos/x86_64/CentOS-7-x86_64-NetInstall-1810.iso",
        "image_checksum_url": "http://miroir.univ-lorraine.fr/centos/7.6.1810/isos/x86_64/sha256sum.txt",
        "image_checksum_type": "sha256",
        "image_name": "centos-7",
        "ssh_private_key_file": "{{env `PACKER_PRIVATE_KEY`}}"
    },
    "builders": [
        {
            "type": "qemu",
            "iso_url": "{{user `image_url`}}",
            "iso_checksum_url": "{{user `image_checksum_url`}}",
            "iso_checksum_type": "{{user `image_checksum_type`}}",
            "shutdown_command": "rm -rf /home/centos/.ssh/authorized_keys && sudo rm -rf /root/.ssh/authorized_keys && echo 'packer' | sudo -S shutdown -P now",
            "disk_size": 8000,
            "disk_compression": true,
            "format": "qcow2",
            "communicator": "ssh",
            "ssh_username": "centos",
            "ssh_handshake_attempts": 200,
            "ssh_private_key_file": "{{user `ssh_private_key_file`}}",
            "ssh_timeout": "300m",
            "ssh_port": 22,
            "vm_name": "{{user `image_name`}}.qcow2",
            "use_default_display": true,
            "disk_interface": "virtio",
            "http_directory": "{{user `image_name`}}/http",
            "vnc_port_min": 5910,
            "vnc_port_max": 5910,
            "boot_command": [
                "<esc>exit<enter><wait3><down><down><enter><down><down><down><down><enter><wait5><up>",
                "e",
                "<down><down>",
                "<leftCtrlOn>e<leftCtrlOff>",
                "<spacebar>",
                "inst.text<spacebar>inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/kickstart.cfg<wait>",
                "<leftCtrlOn>x<leftCtrlOff>"
            ],
            "qemuargs": [
                ["-drive", "file=output-qemu/{{user `image_name`}}.qcow2,if=virtio,cache=writeback,discard=ignore,format=qcow2"],
                ["-drive", "file=rhel/OVMF_CODE.fd,if=pflash,format=raw,unit=0,readonly=on"],
                ["-drive", "file=rhel/testuefi_VARS.fd,if=pflash,format=raw,unit=1"],
                [ "-m", "1000M" ],
                ["-smp", "2"]
            ]
        }
    ],
    "provisioners": [
        {"type": "file",
         "source": "{{user `image_name`}}/cloud-init",
         "destination": "/tmp"
        },
        {"type": "shell",
         "execute_command": "chmod +x {{.Path}}; sudo {{.Path}}",
         "scripts": [
             "scripts/lock-root.sh",
             "scripts/rm-kickstart.sh",
             "{{user `image_name`}}/script.sh",
             "scripts/cloud-cleanup.sh"
         ]
        }
    ]
}
